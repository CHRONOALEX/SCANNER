<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REDPACK PRO - MTY</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --red: #8a2929; --dark: #212529; --green: #28a745; --blue: #007bff; --gray: #f4f4f4; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--gray); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: var(--red); color: white; padding: 12px; text-align: center; font-weight: bold; }
        nav { display: flex; background: var(--dark); min-height: 50px; }
        nav button { flex: 1; padding: 10px; border: none; background: none; color: #adb5bd; font-weight: bold; cursor: pointer; }
        nav button.active { color: white; border-bottom: 4px solid #ffc107; }
        .view { display: none; flex-direction: column; padding: 10px; flex: 1; overflow: hidden; box-sizing: border-box; }
        .view.active { display: flex; }
        
        /* Contenedor de Entrada */
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 10px; }
        .input-group { display: flex; gap: 8px; }
        #scanner-input { flex: 1; padding: 12px; font-size: 1.2em; border: 2px solid var(--red); border-radius: 8px; outline: none; }
        
        /* Bot√≥n de C√°mara */
        .btn-camera { background: var(--blue); border: none; border-radius: 8px; padding: 0 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-camera svg { fill: white; width: 24px; height: 24px; }

        /* Modal del Esc√°ner de C√°mara */
        #camera-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        #reader { width: 90%; max-width: 400px; border-radius: 10px; overflow: hidden; background: black; }
        .close-camera { margin-top: 20px; padding: 12px 30px; background: white; border: none; border-radius: 5px; font-weight: bold; color: black; cursor: pointer; }

        /* Estilos de Tabla y Filtros */
        .scroll-area { flex: 1; overflow-y: auto; background: white; border-radius: 5px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        th { background: #f8f9fa; padding: 10px; position: sticky; top: 0; border-bottom: 2px solid #dee2e6; z-index: 10; }
        td { padding: 12px 5px; border-bottom: 1px solid #eee; text-align: center; }
        .filter-box { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .date-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-bottom: 1px solid #ddd; font-weight: bold; }
        .btn-edit { background: var(--blue); color: white; border: none; padding: 6px; border-radius: 4px; margin-right: 5px; }
        .btn-del { background: #dc3545; color: white; border: none; padding: 6px; border-radius: 4px; }
        
        .error-flash { animation: flash 0.3s; }
        @keyframes flash { 0% { background: white; } 50% { background: #ffcccc; } 100% { background: white; } }
    </style>
</head>
<body>

<header>SCANNER - REDPACK</header>

<nav>
    <button onclick="showView('scanner')" id="btn-scanner" class="active">ESC√ÅNER</button>
    <button onclick="showView('report')" id="btn-report">HISTORIAL NUBE</button>
</nav>

<div class="date-bar">
    <button onclick="changeDay(-1)">‚óÄ</button>
    <span id="date-display">...</span>
    <button onclick="changeDay(1)">‚ñ∂</button>
</div>

<div id="scanner" class="view active">
    <div class="card" id="input-card">
        <select id="service-select" style="width:100%; padding:10px; margin-bottom:10px; border-radius:5px; font-weight:bold;">
            <option>Inyecci√≥n NextDay</option>
            <option>Inyecci√≥n SameDay</option>
            <option>Sobre Da√±ado</option>
            <option>Sobre sin Contenido</option>
            <option>No Manifestado / TBM</option>
        </select>
        <div class="input-group">
            <input type="text" id="scanner-input" placeholder="ESCRIBE O ESCANEA..." autocomplete="off">
            <button class="btn-camera" onclick="openCamera()">
                <svg viewBox="0 0 24 24"><path d="M4 4h3l2-2h6l2 2h3a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm8 15a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0-2a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></svg>
            </button>
        </div>
    </div>
    <div class="scroll-area">
        <table>
            <thead><tr><th>GU√çA LOCAL</th><th>SYNC</th></tr></thead>
            <tbody id="local-table-body"></tbody>
        </table>
    </div>
</div>

<div id="report" class="view">
    <input type="text" id="cloud-search" class="filter-box" placeholder="üîç Filtrar en tiempo real..." oninput="renderCloudUI()">
    <div class="scroll-area">
        <table>
            <thead><tr><th>GU√çA</th><th>SERVICIO</th><th>ACCIONES</th></tr></thead>
            <tbody id="global-table-body"></tbody>
        </table>
    </div>
</div>

<div id="camera-modal">
    <div id="reader"></div>
    <button class="close-camera" onclick="closeCamera()">CANCELAR</button>
</div>

<script>
    const SB_URL = "https://rsgekbibbffbditpdbmc.supabase.co";
    const SB_KEY = "sb_publishable_WhqIrfjaySNqq4tX8v43ZA_fZaQRfMU";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    let inventory = JSON.parse(localStorage.getItem('rp_inventory_v3')) || {};
    let cloudData = [];
    let qrScanner;

    // --- MANEJO DE FECHA MTY ---
    function getMTYDate() {
        const now = new Date();
        const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
        return new Date(utc + (3600000 * -6));
    }
    let viewDate = getMTYDate();
    const getFDate = (d) => `${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}`;

    // --- FUNCI√ìN DE C√ÅMARA (LIBRER√çA) ---
    function openCamera() {
        document.getElementById('camera-modal').style.display = 'flex';
        qrScanner = new Html5Qrcode("reader");
        
        const config = { 
            fps: 15, 
            qrbox: { width: 280, height: 150 }, // Focus horizontal ideal para c√≥digos de barras
            aspectRatio: 1.0 
        };

        qrScanner.start(
            { facingMode: "environment" }, 
            config, 
            (decodedText) => {
                document.getElementById('scanner-input').value = decodedText;
                processScan(decodedText.trim());
                closeCamera();
                if(navigator.vibrate) navigator.vibrate(100);
            },
            (errorMessage) => { /* Silencioso: Error de escaneo continuo */ }
        ).catch(err => {
            alert("Error al acceder a la c√°mara: Aseg√∫rate de usar HTTPS.");
            closeCamera();
        });
    }

    function closeCamera() {
        if (qrScanner) {
            qrScanner.stop().then(() => {
                document.getElementById('camera-modal').style.display = 'none';
            }).catch(() => {
                document.getElementById('camera-modal').style.display = 'none';
            });
        } else {
            document.getElementById('camera-modal').style.display = 'none';
        }
    }

    // --- PROCESAR ESCANEO ---
    async function processScan(code) {
        if(!code) return;
        const dateKey = getFDate(viewDate);
        const service = document.getElementById('service-select').value;

        // Validaci√≥n D√≠gitos
        if (service !== "No Manifestado / TBM") {
            if (!/^\d{8,9}$/.test(code)) {
                playError(); alert("Error: 8 o 9 n√∫meros √∫nicamente."); return;
            }
        }

        // Duplicados
        if(!inventory[dateKey]) inventory[dateKey] = [];
        if(inventory[dateKey].some(i => i.guia === code)) {
            playError(); alert("Gu√≠a repetida hoy."); return;
        }

        const newEntry = { guia: code, servicio: service, synced: false };
        inventory[dateKey].push(newEntry);
        save(); renderUI();

        // Nube
        const { error } = await supabaseClient.from('guias').insert([{ guia: code, servicio: service, fecha_operacion: dateKey }]);
        if(!error) {
            newEntry.synced = true;
            save(); renderUI();
            if(document.getElementById('report').classList.contains('active')) fetchData();
        }
    }

    // --- HISTORIAL NUBE ---
    async function fetchData() {
        const dateKey = getFDate(viewDate);
        const { data, error } = await supabaseClient.from('guias').select('*').eq('fecha_operacion', dateKey).order('created_at', { ascending: false });
        if(!error) { cloudData = data; renderCloudUI(); }
    }

    function renderCloudUI() {
        const q = document.getElementById('cloud-search').value.toLowerCase();
        const filtered = cloudData.filter(i => i.guia.toLowerCase().includes(q) || i.servicio.toLowerCase().includes(q));
        document.getElementById('global-table-body').innerHTML = filtered.map(i => `
            <tr>
                <td><strong>${i.guia}</strong></td>
                <td>${i.servicio}</td>
                <td>
                    <button class="btn-edit" onclick="editItem('${i.id}', '${i.guia}', '${i.servicio}')">‚úé</button>
                    <button class="btn-del" onclick="deleteItem('${i.id}', '${i.guia}')">‚úï</button>
                </td>
            </tr>`).join('');
    }

    async function editItem(id, oldGuia, oldServ) {
        const nGuia = prompt("Nueva Gu√≠a:", oldGuia); if(!nGuia) return;
        const nServ = prompt("Nuevo Servicio (Exacto):", oldServ); if(!nServ) return;
        const { error } = await supabaseClient.from('guias').update({ guia: nGuia, servicio: nServ }).eq('id', id);
        if(!error) { alert("Actualizado"); fetchData(); }
    }

    async function deleteItem(id, guia) {
        if(!confirm(`¬øEliminar gu√≠a ${guia}?`)) return;
        const { error } = await supabaseClient.from('guias').delete().eq('id', id);
        if(!error) {
            const dk = getFDate(viewDate);
            if(inventory[dk]) inventory[dk] = inventory[dk].filter(x => x.guia !== guia);
            save(); fetchData(); renderUI();
        }
    }

    // --- FUNCIONES EXTRA ---
    function save() { localStorage.setItem('rp_inventory_v3', JSON.stringify(inventory)); }
    function renderUI() {
        const dk = getFDate(viewDate);
        document.getElementById('date-display').textContent = dk;
        const data = inventory[dk] || [];
        document.getElementById('local-table-body').innerHTML = data.slice(-8).map(i => `
            <tr><td>${i.guia}</td><td>${i.synced?'‚òÅÔ∏è OK':'‚è≥'}</td></tr>`).reverse().join('');
    }
    function playError() {
        const c = new AudioContext(); const o = c.createOscillator();
        o.frequency.value = 130; o.connect(c.destination); o.start(); o.stop(0.3);
        document.getElementById('input-card').classList.add('error-flash');
        setTimeout(() => document.getElementById('input-card').classList.remove('error-flash'), 300);
    }
    function showView(v) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(e => e.classList.remove('active'));
        document.getElementById(v).classList.add('active');
        document.getElementById('btn-'+v).classList.add('active');
        if(v === 'report') fetchData();
    }
    function changeDay(n) {
        let t = new Date(viewDate); t.setDate(viewDate.getDate() + n);
        if(t > getMTYDate()) return;
        viewDate = t; renderUI(); fetchData();
    }
    document.getElementById('scanner-input').addEventListener('keydown', e => {
        if(e.key === 'Enter') { processScan(e.target.value.trim()); e.target.value = ''; }
    });

    window.onload = () => { renderUI(); fetchData(); document.getElementById('scanner-input').focus(); };
</script>
</body>
</html>