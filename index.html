<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REDPACK SCANNER V3 - SUPABASE</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --red: #8a2929; --dark: #212529; --green: #28a745; --blue: #007bff; --gray: #f4f4f4;
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--gray); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: var(--red); color: white; padding: 12px; text-align: center; font-weight: bold; font-size: 1.1em; }
        
        nav { display: flex; background: var(--dark); min-height: 50px; }
        nav button { flex: 1; padding: 10px; border: none; background: none; color: #adb5bd; font-weight: bold; cursor: pointer; transition: 0.3s; }
        nav button.active { color: white; border-bottom: 4px solid #ffc107; }

        .view { display: none; flex-direction: column; padding: 10px; flex: 1; overflow: hidden; box-sizing: border-box; }
        .view.active { display: flex; }

        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 10px; }
        
        #scanner-input { 
            width: 100%; padding: 12px; font-size: 1.4em; text-align: center; 
            border: 2px solid var(--red); border-radius: 8px; box-sizing: border-box; outline: none;
        }
        #scanner-input:focus { border-color: var(--green); box-shadow: 0 0 8px rgba(40, 167, 69, 0.2); }

        .search-container { margin-bottom: 8px; }
        #local-search { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }

        .scroll-area { flex: 1; overflow-y: auto; background: white; border-radius: 5px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th { background: #f8f9fa; padding: 10px; position: sticky; top: 0; border-bottom: 2px solid #dee2e6; font-size: 0.8em; color: #666; }
        td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: center; font-family: monospace; }

        .btn-del { background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
        .btn-edit { background: var(--blue); color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-right: 4px; }
        
        .date-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-bottom: 1px solid #ddd; font-weight: bold; }
        .sync-badge { font-size: 0.7em; padding: 2px 6px; border-radius: 10px; background: #e9ecef; color: #666; }
    </style>
</head>
<body>

    <header>REDPACK CONTROL DE INYECCI√ìN</header>

    <nav>
        <button onclick="showView('scanner')" id="btn-scanner" class="active">SCANNER</button>
        <button onclick="showView('report')" id="btn-report">HISTORIAL NUBE</button>
    </nav>

    <div class="date-bar">
        <button onclick="changeDay(-1)" style="border:none; background:none; font-size:1.2em; cursor:pointer;">‚óÄ</button>
        <span id="date-display">Cargando...</span>
        <button onclick="changeDay(1)" style="border:none; background:none; font-size:1.2em; cursor:pointer;">‚ñ∂</button>
    </div>

    <div id="scanner" class="view active">
        <div class="card">
            <label style="font-size: 0.8em; color: #666;">SERVICIO ACTUAL:</label>
            <select id="service-select" style="width:100%; padding:10px; margin: 8px 0; font-weight: bold; border-radius: 5px;">
                <option>Inyecci√≥n NextDay</option>
                <option>Inyecci√≥n SameDay</option>
                <option>Sobre Da√±ado</option>
                <option>Sobre sin Contenido</option>
                <option>No Manifestado / TBM</option>
            </select>
            <input type="text" id="scanner-input" placeholder="ESCANEAR GU√çA..." autocomplete="off">
        </div>

        <div class="search-container">
            <input type="text" id="local-search" placeholder="üîç Buscar gu√≠a en la lista de hoy..." oninput="renderUI()">
        </div>

        <div class="scroll-area">
            <table>
                <thead><tr><th>GU√çA</th><th>ACCIONES</th></tr></thead>
                <tbody id="local-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="report" class="view">
        <div style="margin-bottom: 10px;">
            <button onclick="fetchData()" style="width:100%; padding:12px; background:var(--dark); color:white; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">‚òÅÔ∏è SINCRONIZAR CON SUPABASE</button>
        </div>
        <div class="scroll-area">
            <table>
                <thead><tr><th>GU√çA</th><th>SERVICIO</th><th>ESTADO</th></tr></thead>
                <tbody id="global-table-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN SUPABASE
        const SB_URL = "https://rsgekbibbffbditpdbmc.supabase.co";
        const SB_KEY = "sb_publishable_WhqIrfjaySNqq4tX8v43ZA_fZaQRfMU";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        let inventory = JSON.parse(localStorage.getItem('rp_inventory_v3')) || {};
        let viewDate = new Date();

        function getFDate(d) {
            return `${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}`;
        }

        // Funci√≥n de Escaneo
        async function processScan(code) {
            if(!code) return;
            const dateKey = getFDate(viewDate);
            const service = document.getElementById('service-select').value;

            // 1. Guardar local inmediato (Velocidad)
            if(!inventory[dateKey]) inventory[dateKey] = [];
            
            // Evitar duplicados locales
            if(inventory[dateKey].some(i => i.guia === code)) {
                alert("‚ùå GU√çA YA ESCANEADA HOY");
                return;
            }

            const newEntry = { guia: code, servicio: service, hora: new Date().toLocaleTimeString(), synced: false };
            inventory[dateKey].push(newEntry);
            save();
            renderUI();

            // 2. Subir a Supabase (Segundo plano)
            try {
                const { error } = await supabaseClient
                    .from('guias')
                    .insert([{ guia: code, servicio: service, fecha_operacion: dateKey }]);
                
                if(!error) {
                    newEntry.synced = true;
                    save();
                    renderUI();
                }
            } catch (err) {
                console.error("Error de red, se queda local.");
            }
        }

        async function deleteItem(guia) {
            if(!confirm(`¬øEliminar gu√≠a ${guia}?`)) return;
            const dateKey = getFDate(viewDate);
            
            // Borrar en Supabase
            await supabaseClient.from('guias').delete().eq('guia', guia).eq('fecha_operacion', dateKey);
            
            // Borrar Local
            if(inventory[dateKey]) {
                inventory[dateKey] = inventory[dateKey].filter(item => item.guia !== guia);
            }
            save();
            renderUI();
        }

        async function editItem(oldGuia) {
            const newGuia = prompt("Editar n√∫mero de gu√≠a:", oldGuia);
            if(!newGuia || newGuia === oldGuia) return;
            const dateKey = getFDate(viewDate);

            // Actualizar Supabase
            await supabaseClient.from('guias')
                .update({ guia: newGuia })
                .eq('guia', oldGuia)
                .eq('fecha_operacion', dateKey);
            
            // Actualizar Local
            if(inventory[dateKey]) {
                const item = inventory[dateKey].find(i => i.guia === oldGuia);
                if(item) item.guia = newGuia;
            }
            save();
            renderUI();
        }

        async function fetchData() {
            const dateKey = getFDate(viewDate);
            const { data, error } = await supabaseClient
                .from('guias')
                .select('*')
                .eq('fecha_operacion', dateKey);

            if(!error && data) {
                inventory[dateKey] = data.map(d => ({ 
                    guia: d.guia, 
                    servicio: d.servicio, 
                    hora: 'Nube', 
                    synced: true 
                }));
                save();
                renderUI();
                alert("‚úÖ Datos actualizados desde la nube");
            }
        }

        function renderUI() {
            const dateKey = getFDate(viewDate);
            document.getElementById('date-display').textContent = dateKey;
            const search = document.getElementById('local-search').value.toLowerCase();
            const data = inventory[dateKey] || [];

            // Tabla Scanner (Solo hoy + Filtro)
            const filtered = data.filter(i => i.guia.toLowerCase().includes(search));
            document.getElementById('local-table-body').innerHTML = filtered.map(i => `
                <tr>
                    <td style="font-weight:bold;">${i.guia}</td>
                    <td>
                        <button class="btn-edit" onclick="editItem('${i.guia}')">‚úé</button>
                        <button class="btn-del" onclick="deleteItem('${i.guia}')">‚úï</button>
                    </td>
                </tr>`).reverse().join('');

            // Tabla Historial
            document.getElementById('global-table-body').innerHTML = data.map(i => `
                <tr>
                    <td>${i.guia}</td>
                    <td style="font-size:0.8em; color:#666;">${i.servicio}</td>
                    <td><span class="sync-badge">${i.synced ? '‚òÅÔ∏è OK' : '‚è≥ Pend'}</span></td>
                </tr>`).reverse().join('');
        }

        // Utilidades
        function save() { localStorage.setItem('rp_inventory_v3', JSON.stringify(inventory)); }
        
        function showView(v) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
            document.getElementById(v).classList.add('active');
            document.getElementById('btn-'+v).classList.add('active');
            if(v === 'scanner') setTimeout(() => document.getElementById('scanner-input').focus(), 100);
        }

        function changeDay(n) { viewDate.setDate(viewDate.getDate() + n); renderUI(); }

        // Evento de teclado
        document.getElementById('scanner-input').addEventListener('keydown', e => {
            if(e.key === 'Enter') {
                processScan(e.target.value.trim());
                e.target.value = '';
            }
        });

        // Inicio
        window.onload = () => {
            renderUI();
            document.getElementById('scanner-input').focus();
            // Opcional: sincronizar al abrir
            fetchData();
        };
    </script>
</body>
</html>